<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Canvas Demo</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
</head>

<body>
  <h1>Canvas Demo</h1>
  <canvas id=canvas width=1080 height=608></canvas>

  <a class="btn btn-primary" href="#" onclick='download_image();' role="button">Download</a>

  <script>
    var sources = {
      bg: 'image/bg/kitchen-3.png',
      tile: 'image/tile/wall/1009HL.png'
    };


    window.onload = function () {
      var canvas = document.getElementById("canvas");
      var ctx = canvas.getContext("2d");

      var bgImg = new Image();
      bgImg.src = sources["bg"];
      bgImg.onload = function () {
        ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);
        //ctx.restore();
      }

      //ctx.fillStyle = "green";
      //ctx.fillRect(0, 30, 1080, 250);

      // temp canvas 
      var tileImg = new Image();
      tileImg.src = sources["tile"];
      tileImg.onload = () => {

        var tempCanvas = drawTile(tileImg, tileImg.width, tileImg.height)
        ctx.fillStyle = ctx.createPattern(tempCanvas, 'repeat');
        ctx.beginPath();
        ctx.rect(0, 30, canvas.width, 250);
        ctx.closePath();
        ctx.fill();
      }

    }

    function drawTile(tileImg, tileWidth, tileHeight) {
      var tempCanvas = document.createElement("canvas");
      var temp_ctx = tempCanvas.getContext("2d");

      tempCanvas.width = 96;
      tempCanvas.height = 66;
      temp_ctx.drawImage(tileImg, 0, 0, tileWidth, tileHeight, 0, 0, tempCanvas.width, tempCanvas.height);
      return tempCanvas;
    }

    function download_image() {
      var canvas = document.getElementById("canvas");
      // no argument defaults to image/png; image/jpeg, etc also work on some
      // implementations -- image/png is the only one that must be supported per spec.

      window.location = canvas.toDataURL("image/png");
      window.open(canvas.toDataURL('image/png'));
      console.log("clicked")

    }
  </script>
</body>

</html>